<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Swim Announcer v50 (Anchor-Based Engine)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

    <style>
        :root { --primary: #0f172a; --accent: #3b82f6; --bg: #f8fafc; --text: #334155; --surface: #ffffff; --green: #10b981; --red: #ef4444; --orange: #f59e0b; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        .sidebar { width: 380px; background: var(--primary); color: #94a3b8; display: flex; flex-direction: column; border-right: 1px solid #334155; z-index: 50; box-shadow: 4px 0 15px rgba(0,0,0,0.1); }
        .sidebar-header { padding: 15px 20px; background: #020617; border-bottom: 1px solid #1e293b; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .sidebar-header h2 { margin: 0; color: white; font-size: 1.1rem; letter-spacing: 0.5px; }
        .settings-btn { background: none; border: none; color: #94a3b8; cursor: pointer; font-size: 1.2rem; transition: 0.2s; }
        .settings-btn:hover { color: white; transform: rotate(90deg); }

        .scroll-area { overflow-y: auto; flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 20px; }

        .view-section { display: none; flex-direction: column; gap: 20px; animation: fadeIn 0.3s; }
        .view-section.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; display: block; margin-bottom: 6px; color: #64748b; }
        input[type="text"], input[type="password"], textarea, select { width: 100%; background: #1e293b; border: 1px solid #334155; color: #f8fafc; padding: 10px; border-radius: 6px; font-family: monospace; font-size: 0.85rem; box-sizing: border-box; }
        input:focus, textarea:focus { border-color: var(--accent); outline: none; }
        
        .radio-group { display: flex; flex-direction: column; gap: 8px; background: #1e293b; padding: 10px; border-radius: 8px; border: 1px solid #334155; }
        .radio-option { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .radio-option input { accent-color: var(--accent); }
        .radio-label-main { color: #f8fafc; font-weight: bold; font-size: 0.9rem; }
        .radio-label-sub { color: #94a3b8; font-size: 0.75rem; }

        .file-upload-box { border: 2px dashed #334155; padding: 15px; text-align: center; border-radius: 8px; cursor: pointer; transition: 0.2s; background: #1e293b; }
        .file-upload-box:hover { border-color: var(--accent); }
        input[type="file"] { display: none; }

        .template-tabs { display: flex; gap: 5px; margin-bottom: 5px; }
        .tab-btn { flex: 1; background: #1e293b; border: 1px solid #334155; color: #94a3b8; padding: 8px; font-size: 0.75rem; cursor: pointer; border-radius: 4px; text-align: center; transition: 0.2s; }
        .tab-btn.active { background: var(--accent); color: white; border-color: var(--accent); font-weight: bold; }

        .action-area { padding: 20px; background: #020617; border-top: 1px solid #1e293b; flex-shrink: 0; }
        .btn-gen { width: 100%; background: var(--accent); color: white; border: none; padding: 14px; border-radius: 8px; font-weight: bold; font-size: 0.9rem; cursor: pointer; transition: 0.2s; }
        
        .main { flex: 1; display: flex; flex-direction: column; height: 100vh; background: #f1f5f9; position: relative; overflow: hidden; }
        .top-bar { padding: 15px 30px; background: var(--surface); border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; z-index: 1000; }
        
        .status { font-weight: bold; font-size: 0.9rem; color: #64748b; }
        .status.ready { color: var(--green); }

        .list-container { flex: 1; overflow-y: auto; padding: 30px; padding-bottom: 140px; }
        
        .heat-block { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 30px; border: 1px solid #e2e8f0; overflow: hidden; }
        .heat-header { background: #f8fafc; padding: 12px 20px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .heat-header.active { background: #eff6ff; border-left: 5px solid var(--accent); }
        .heat-title { font-weight: 800; font-size: 1.1rem; color: #475569; }

        .swimmer-row { display: flex; align-items: center; padding: 10px 20px; border-bottom: 1px solid #f1f5f9; background: white; }
        .swimmer-row.active { background: #eff6ff; border-left: 5px solid var(--accent); }
        .col-lane { width: 50px; font-weight: 800; font-size: 1.2rem; color: #cbd5e1; text-align: center; }
        .col-info { flex: 1; padding: 0 15px; }
        .name-text { font-weight: 700; color: #334155; font-size: 1.05rem; }
        .team-text { font-size: 0.85rem; color: #64748b; }
        .col-time { font-family: monospace; font-size: 0.85rem; color: #94a3b8; background: #f1f5f9; padding: 4px 8px; border-radius: 4px; }
        
        .heat-footer { background: #f8fafc; padding: 8px; text-align: center; border-top: 1px solid #e2e8f0; color: #64748b; cursor: pointer; }
        .heat-footer.active { background: var(--primary); color: white; }

        .go-container { position: absolute; bottom: 30px; right: 30px; width: 100px; height: 100px; z-index: 100; }
        .btn-go { width: 100%; height: 100%; border-radius: 50%; background: var(--green); color: white; font-weight: 900; border: 4px solid #14532d; cursor: pointer; font-size: 1.5rem; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-header">
        <h2 id="sidebarTitle">üèä RUN SHOW</h2>
        <button class="settings-btn" onclick="toggleSettings()">‚öôÔ∏è</button>
    </div>
    
    <div class="scroll-area">
        <div id="viewMain" class="view-section active">
            <div>
                <label>1. HY-TEK REPORT FORMAT</label>
                <div class="radio-group">
                    <label class="radio-option">
                        <input type="radio" name="hytekMode" value="heat2col" checked onchange="manualParse()">
                        <div>
                            <div class="radio-label-main">Heats (2-Columns)</div>
                            <div class="radio-label-sub">Left & Right columns.</div>
                        </div>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="hytekMode" value="result1col" onchange="manualParse()">
                        <div>
                            <div class="radio-label-main">Results/Psych (1-Column)</div>
                            <div class="radio-label-sub">List rankings top-to-bottom.</div>
                        </div>
                    </label>
                </div>
            </div>

            <div style="margin-top:20px;">
                <label>2. Upload File</label>
                <label class="file-upload-box">
                    <span id="fileNameDisplay" style="font-size:1.5rem;">üìÑ / üì∑</span>
                    <div class="file-upload-text">Drag PDF or Image</div>
                    <input type="file" id="pdfUpload" accept=".pdf,.png,.jpg,.jpeg" onchange="handleFileUpload(this)">
                </label>
            </div>

            <div style="margin-top:10px;">
                <label>Name Format</label>
                <select id="nameFormatSelect" onchange="manualParse()">
                    <option value="last_first">Last, First</option>
                    <option value="first_last">First Last</option>
                </select>
            </div>

            <div>
                <div class="template-tabs" style="margin-top:15px;">
                    <button class="tab-btn active" id="btnTab1" onclick="switchTab(1)">1. Heats</button>
                    <button class="tab-btn" id="btnTab2" onclick="switchTab(2)">2. Finalists</button>
                    <button class="tab-btn" id="btnTab3" onclick="switchTab(3)">3. Results</button>
                    <button class="tab-btn" id="btnTab4" onclick="switchTab(4)">4. Awards</button>
                </div>
                <textarea id="templatePreview" style="height:60px; opacity:0.7; cursor:pointer;" readonly onclick="toggleScriptEditor()"></textarea>
            </div>

            <div>
                <label>3. Voice Engine</label>
                <select id="engineSelect" onchange="updateVoiceOptions()" style="margin-bottom:10px;">
                    <option value="openai">OpenAI</option>
                    <option value="elevenlabs">ElevenLabs</option>
                </select>
                <select id="voiceSelect" onchange="saveConfig()"></select>
            </div>
        </div>

        <div id="viewSettings" class="view-section">
            <div><label>OpenAI Key</label><input type="password" id="apiKey" onchange="saveConfig()"></div>
            <div><label>Eleven Key</label><input type="password" id="elevenKey" onchange="saveConfig()"></div>
        </div>
    </div>

    <div class="action-area">
        <button id="btnGenerate" class="btn-gen" onclick="generateAudio()">‚ö° GENERATE AUDIO</button>
        <button onclick="clearSession()" style="width:100%; margin-top:10px; background:#334155; color:white; border:none; padding:8px; border-radius:6px; cursor:pointer;">üóëÔ∏è CLEAR</button>
    </div>
</div>

<div class="main">
    <div class="top-bar">
        <div><span id="statusText" class="status">Waiting for file...</span></div>
        <button onclick="stopPlayback()" style="background:var(--red); color:white; border:none; padding:8px 15px; border-radius:6px; cursor:pointer; font-weight:bold;">üõë STOP</button>
    </div>
    <div class="list-container" id="listContainer"></div>
    <div class="go-container"><button class="btn-go" onclick="triggerGo()">GO</button></div>
</div>

<div class="modal-overlay" id="scriptModal" onclick="if(event.target===this) toggleScriptEditor()">
    <div class="modal-content">
        <div class="modal-header"><div class="modal-title">‚úèÔ∏è SCRIPT EDITOR</div></div>
        <label>INTRO</label><textarea id="introScriptInput" style="height:40px;" oninput="syncScript()"></textarea>
        <label>SWIMMER</label><textarea id="modalTemplateInput" style="height:80px;" oninput="syncScript()"></textarea>
        <label>OUTRO</label><textarea id="outroScriptInput" style="height:40px;" oninput="syncScript()"></textarea>
        <button class="btn-gen" onclick="toggleScriptEditor()" style="margin-top:20px;">DONE</button>
    </div>
</div>

<script>
    let heats = {}; let heatOrder = []; let audioCache = {}; let currentSelection = { heat: null, index: -1 };
    let currentAudioObject = null;

    window.onload = () => {
        if(localStorage.getItem('openai_key')) document.getElementById('apiKey').value = localStorage.getItem('openai_key');
        if(localStorage.getItem('eleven_key')) document.getElementById('elevenKey').value = localStorage.getItem('eleven_key');
        updateVoiceOptions();
        loadTemplateUI();
        if(localStorage.getItem('saved_heats')) loadSession();
    };

    function saveConfig() {
        localStorage.setItem('openai_key', document.getElementById('apiKey').value.trim());
        localStorage.setItem('eleven_key', document.getElementById('elevenKey').value.trim());
        localStorage.setItem('engine_pref', document.getElementById('engineSelect').value);
    }

    function updateVoiceOptions() {
        const engine = document.getElementById('engineSelect').value;
        const select = document.getElementById('voiceSelect');
        select.innerHTML = "";
        const voices = (engine === 'openai') ? [{id:'nova', name:'Nova'}, {id:'onyx', name:'Onyx'}] : [{id:'JBFqnCBsd6RMkjVDRZzb', name:'George'}];
        voices.forEach(v => { const opt = document.createElement('option'); opt.value = v.id; opt.innerText = v.name; select.appendChild(opt); });
    }

    function toggleSettings() {
        document.getElementById('viewMain').classList.toggle('active');
        document.getElementById('viewSettings').classList.toggle('active');
    }

    async function handleFileUpload(input) {
        if (!input.files[0]) return;
        const file = input.files[0];
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
        const mode = document.querySelector('input[name="hytekMode"]:checked').value;
        let fullText = "";

        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            const viewport = page.getViewport({ scale: 1 });
            const items = textContent.items.map(d => ({ str: d.str, x: d.transform[4], y: d.transform[5] }));

            if (mode === 'heat2col') {
                const mid = viewport.width / 2;
                const left = items.filter(it => it.x < mid).sort((a,b) => b.y - a.y || a.x - b.x);
                const right = items.filter(it => it.x >= mid).sort((a,b) => b.y - a.y || a.x - b.x);
                fullText += processBlock(left) + "\n" + processBlock(right) + "\n";
            } else {
                items.sort((a,b) => b.y - a.y || a.x - b.x);
                fullText += processBlock(items) + "\n";
            }
        }
        document.getElementById('dataInputModal').value = fullText;
        manualParse();
    }

    function processBlock(items) {
        let lines = [], currentLine = [], lastY = items[0]?.y || 0;
        items.forEach(d => {
            if (Math.abs(d.y - lastY) > 5) { lines.push(currentLine.sort((a,b)=>a.x-b.x).map(o=>o.str).join(" ")); currentLine = []; lastY = d.y; }
            currentLine.push(d);
        });
        if(currentLine.length) lines.push(currentLine.sort((a,b)=>a.x-b.x).map(o=>o.str).join(" "));
        return lines.join("\n");
    }

    function manualParse() {
        const mode = document.querySelector('input[name="hytekMode"]:checked').value;
        const raw = document.getElementById('dataInputModal').value;
        const format = document.getElementById('nameFormatSelect').value;
        let parsed = [];
        let currentEvt = "Unknown", currentEvtName = "";

        if (mode === 'result1col') {
            // Clean noise like page headers
            const lines = raw.split('\n').filter(l => !l.match(/Page|HY-TEK|MANAGER/i));
            const blob = lines.join(" ").replace(/\s{2,}/g, " ");

            const evtMatch = blob.match(/(?:Event|Evt)\s*(\d+)\s+(.*?)(?=\s+(?:Lane|Name|Heat|Rank|1\s+))/i);
            if(evtMatch) { currentEvt = evtMatch[1]; currentEvtName = evtMatch[2].trim(); }

            // ANCHOR SEARCH: Search for "-IL" or other team suffixes to find swimmer lines
            const regex = /(\d{1,2})\s+([A-Za-z',\.\-\s]+?)\s+(\d{1,2})\s+([A-Z0-9\s\-]+?)\s+((?:NT|[\d:\.]+\s*)+)/g;
            let m;
            while ((m = regex.exec(blob)) !== null) {
                let name = m[2].trim();
                if (format === 'last_first' && name.includes(',')) {
                    const p = name.split(',');
                    name = `${p[1].trim().split(' ')[0]} ${p[0].trim()}`;
                }
                parsed.push({ heatId: `E${currentEvt}-H1`, heatTitle: `Event ${currentEvt} - ${currentEvtName}`, lane: m[1], name: name, team: m[4].trim(), time: m[5].trim().split(' ').pop() });
            }
        } else {
            // Standard Heat Parsing
            const lines = raw.split('\n');
            let curHeat = "1";
            lines.forEach(l => {
                const em = l.match(/(?:Event|Evt)\s*(\d+)\s+(.*)/i);
                if(em) { currentEvt = em[1]; currentEvtName = em[2].trim(); }
                const hm = l.match(/Heat\s+(\d+)/i);
                if(hm) curHeat = hm[1];
                const m = l.match(/^\s*(\d{1,2})\s+([A-Za-z, \.-]+?)\s+(\d{1,2})\s+([A-Za-z0-9\s\.-]+?)\s+(NT|[\d:.]+)/i);
                if(m) parsed.push({ heatId: `E${currentEvt}-H${curHeat}`, heatTitle: `Event ${currentEvt} - Heat ${curHeat}`, lane: m[1], name: m[2].trim(), team: m[4].trim(), time: m[5] });
            });
        }

        if(parsed.length) {
            heats = {}; heatOrder = [];
            parsed.forEach(s => {
                if(!heats[s.heatId]) { heats[s.heatId] = { title: s.heatTitle, swimmers: [] }; heatOrder.push(s.heatId); }
                heats[s.heatId].swimmers.push(s);
            });
            renderBoard();
            setStatus(`Found ${parsed.length} swimmers.`, "ready");
        }
    }

    function renderBoard() {
        const container = document.getElementById('listContainer');
        container.innerHTML = "";
        heatOrder.forEach(hk => {
            const g = heats[hk];
            const block = document.createElement('div');
            block.className = 'heat-block';
            block.innerHTML = `<div class="heat-header ${currentSelection.heat===hk && currentSelection.index===-1?'active':''}"><div class="heat-title">${g.title}</div></div>`;
            g.swimmers.forEach((s, i) => {
                const row = document.createElement('div');
                row.className = `swimmer-row ${currentSelection.heat===hk && currentSelection.index===i?'active':''}`;
                row.innerHTML = `<div class="col-lane">${s.lane}</div><div class="col-info"><div class="name-text">${s.name}</div><div class="team-text">${s.team}</div></div><div class="col-time">${s.time}</div>`;
                block.appendChild(row);
            });
            block.innerHTML += `<div class="heat-footer ${currentSelection.heat===hk && currentSelection.index===-2?'active':''}">üì¢ Outro</div>`;
            container.appendChild(block);
        });
    }

    function switchTab(t) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btnTab'+t).classList.add('active');
        loadTemplateUI();
    }

    function loadTemplateUI() {
        const t = document.querySelector('.tab-btn.active').innerText.split('.')[0];
        const defaults = { 1: "In lane {lane}, from {team}, {name}.", 3: "In {place} place, from {team}, {name}." };
        document.getElementById('modalTemplateInput').value = defaults[t] || "";
        document.getElementById('templatePreview').value = defaults[t] || "";
    }

    function toggleScriptEditor() { document.getElementById('scriptModal').style.display = (document.getElementById('scriptModal').style.display==='flex'?'none':'flex'); }
    function syncScript() { document.getElementById('templatePreview').value = document.getElementById('modalTemplateInput').value; }

    function stopPlayback() { if(currentAudioObject) currentAudioObject.pause(); }
    function triggerGo() { /* Logic for playing audio cache sequence */ }

    async function generateAudio() {
        const key = document.getElementById('apiKey').value;
        const voice = document.getElementById('voiceSelect').value;
        setStatus("Generating...", "working");
        // Logic to hit OpenAI/Eleven API and cache results
        setStatus("Ready.", "ready");
    }
</script>

</body>
</html>
